<!DOCTYPE html>
<html>
    <head>
        <title>PureCloud App LFC2 Test</title>

        <style>
            body {
                margin: 0;
            }
        </style>

        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://sdk-cdn.mypurecloud.com/client-apps/1.4.0/purecloud-client-app-sdk.js"></script>
 
    </head>

    <body>
        <noscript>
            For full functionality of this site it is necessary to enable JavaScript. Here are the <a href="http://www.enable-javascript.com/" target="_blank">instructions how to enable JavaScript in your web browser</a>.
        </noscript>

        <h1>PureCloud App LFC2 Test</h1>
        <p>
            PureCloud Apps have a full lifecycle that developers can utilize to
            provide a seamless experience for end users.
        </p>
        <hr>

        <section>
            <h1 id="Welcome" width="100%" align="center">Welcome </h1>
            <br>
            <br>
            <h1>App Lifecycle</h1>
            <ol>
                <li>Loading - The app's iframe is loading</li>
                <li>Bootstrapping (Opt-in)
                    <ul>
                        <li>'bootstrap' message fired from PureCloud after load</li>
                        <li>PureCloud awaits app 'bootstrapped' response (Will timeout)</li>
                    </ul>
                </li>
                <li>Running
                    <ul>
                        <li>'blur' message fired from PureCloud on app blur (Opt-in)</li>
                        <li>'focus' message fired from PureCloud on subsequent app focus (Opt-in)</li>
                    </ul>
                </li>
                <li>Stopping (Opt-in)
                    <ul>
                        <li>'stop' message fired from PureCloud after load</li>
                        <li>PureCloud awaits app 'stopped' response (Will timeout)</li>
                    </ul>
                </li>
                <li>Stopped - The app has shut down and the iframe will be removed from PureCloud</li>
            </ol>
        </section>

        <section class="lifecycle-events">
            <h1>Lifecycle Events Log:</h1>
            <ul class="log lifecycle-event-log">
            </ul>
        </section>

        <script src="https://sdk-cdn.mypurecloud.com/javascript/89.0.0/purecloud-platform-client-v2.min.js"></script>
        
        <script>
            
            $( document ).ready(function() {
                //Purecloud Oauth information
                var platformClient = require('platformClient');
                var client = platformClient.ApiClient.instance;
                var clientId = 'f481400e-e257-4529-8b1d-c52ac27575e0';
                var redirectUri = 'https://jhe277.github.io/LFC2TEST/lfctest2.html'; //clientApp address - same as the clientApp configuration url without parameters
        
                client.setEnvironment(platformClient.PureCloudRegionHosts.eu_central_1);
                
                //API instances
                var usersApi = new platformClient.UsersApi();
                var notificationsApi = new platformClient.NotificationsApi();
        
                //Perform Implicit Login Grant Authentication
                client.loginImplicitGrant(clientId, redirectUri)
                    .then((data) => {
                        //User Authenticated
                        console.log("LFC2: Authenticated: " + data);
                        //Make request to GET /api/v2/users/me?expand=presence
                        return usersApi.getUsersMe({ 'expand': ["presence"] });
                    })
                    .then((userMe) => {
                        //Me Response
                        document.querySelector("#Welcome").innerHTML = "Welcome " + userMe.name;
                        console.log("LFC2: Hello, "+userMe.name+"!");
                        return notificationsApi.postNotificationsChannels();
                    }).then((channel) => {
                        //Channel Created
                        //Set WebSocket in Channel
                        var socket = new WebSocket(channel.connectUri);
                        socket.onmessage = onSocketMessage;
                        //Subscribe to conversation events in the queue
                        let topic = [{"id": "v2.routing.queues.52672129-f97b-40c1-b011-f50e6a577259.conversations.calls"}];
                        return notificationsApi.postNotificationsChannelSubscriptions(channel.id, topic);
                    }).catch((err) => {
                        //Handle failure response
                        console.log("LFC2: "+err);
                    });
                
                    //Handler for every Websocket message
                    function onSocketMessage(event){
                        console.log("LFC2: Websocket Event Received: " + event.data);
                        let data = JSON.parse(event.data);
                        let topic = data.topicName;
                        let eventBody = data.eventBody;
        
                        console.log("LFC2: Notification: Topic = " + topic);
                        console.log("LFC2: Notification: Body = " + eventBody);
        
                        //Add a bomb to the Game
                        if ( topic == "v2.routing.queues.52672129-f97b-40c1-b011-f50e6a577259.conversations" ) {
                            //Do stuff
                            //addBomb();
                            //document.querySelector(".lifecycle-event-log").innerHTML = "Welcome " + userMe.name;

                            var mylogText = "LFC2: New conversation notification"

                            $tgt = jQuery('.lifecycle-events .log')
                            var newItem = $('<li>' + mylogText + '</li>');
                            var incommingEvent = true;
                            newItem.addClass(incommingEvent ? 'incomming' : 'outgoing');

                            $tgt.prepend(newItem);

                            //myClientApp.alerting.showToastPopup('App LFC2', 'Conversation Event Perusjonotesti1');
                            console.log("LFC2: Conversation Event Perusjonotesti1");
                        }
                    };
                });
                </script>
                
        </body>
</html>
